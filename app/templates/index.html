<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç†å¹³å° - PayIPA</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div id="app">
    <div class="container">
        <div v-if="!isLoggedIn" class="card"
             style="max-width: 500px; margin: 15vh auto; text-align: center; padding: 3rem;">
            <div class="header">
                <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--danger-color);">ğŸ”’</h1>
                <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: var(--dark-text);">éœ€è¦ç™»å½•</h2>
                <p class="welcome-message" style="font-size: 1.1rem;">è¯·å…ˆç™»å½•ä»¥è®¿é—®æ­¤é¡µé¢</p>
            </div>
            <div style="margin-top: 2rem;">
                <a href="/login" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px;">å‰å¾€ç™»å½•</a>
            </div>
        </div>

        <div v-else class="main-content">
            <header class="header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“‹ ä»»åŠ¡ç®¡ç†å¹³å°</h1>
                        <p class="welcome-message">æ¬¢è¿å›æ¥ï¼Œ{{ userInfo.full_name || userInfo.email }}ï¼</p>
                    </div>
                    <button @click="logout" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
                </div>
            </header>

            <div class="task-controls">
                <div class="search-filter">
                    <input type="text" v-model="searchTerm" placeholder="ğŸ” æœç´¢ä»»åŠ¡..." class="search-input">
                    <select v-model="filterStatus" class="filter-select">
                        <option value="all">å…¨éƒ¨ä»»åŠ¡</option>
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="in-progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>

                <button @click="openAddTaskModal" class="btn btn-primary">+ æ·»åŠ æ–°ä»»åŠ¡</button>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <h3>{{ stats.totalTasks }}</h3>
                    <p>æ€»ä»»åŠ¡æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>{{ stats.pendingTasks }}</h3>
                    <p>å¾…å¤„ç†</p>
                </div>
                <div class="stat-card">
                    <h3>{{ stats.completedTasks }}</h3>
                    <p>å·²å®Œæˆ</p>
                </div>
            </div>

            <table class="tasks-table">
                <thead>
                <tr>
                    <th style="width: 30%;">ä»»åŠ¡åç§°</th>
                    <th style="width: 15%;">çŠ¶æ€</th>
                    <th style="width: 15%;">ä¼˜å…ˆçº§</th>
                    <th style="width: 20%;">æˆªæ­¢æ—¥æœŸ</th>
                    <th style="width: 20%;">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="task in filteredTasks" :key="task.id">
                    <td>
                        <strong>{{ task.name }}</strong>
                        <div style="font-size: 0.9rem; color: var(--light-text); margin-top: 0.25rem;"
                             v-if="task.description">{{ task.description }}
                        </div>
                    </td>
                    <td><span class="status-badge"
                              :class="'status-' + task.status">{{ getStatusText(task.status) }}</span></td>
                    <td><span :class="'priority-' + task.priority">{{ getPriorityText(task.priority) }}</span></td>
                    <td>{{ task.dueDate || '-' }}</td>
                    <td>
                        <button @click="openEditTaskModal(task)" class="btn btn-secondary btn-sm">ç¼–è¾‘</button>
                        <button @click="deleteTask(task.id)" class="btn btn-danger btn-sm">åˆ é™¤</button>
                    </td>
                </tr>
                <tr v-if="filteredTasks.length === 0">
                    <td colspan="5" style="text-align: center; padding: 30px; color: var(--light-text);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
                        <h3>æš‚æ— ä»»åŠ¡</h3>
                        <p>æ‚¨å¯ä»¥ç‚¹å‡»"æ·»åŠ æ–°ä»»åŠ¡"æŒ‰é’®æ¥åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡</p>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- ä»»åŠ¡æ¨¡æ€æ¡† -->
            <div v-if="showModal" class="modal" @click="closeTaskModal">
                <div class="modal-content" @click.stop>
                    <span class="close" @click="closeTaskModal">&times;</span>
                    <h2>{{ modalTitle }}</h2>
                    <form @submit.prevent="saveTask">
                        <div class="form-group">
                            <label for="taskName">ä»»åŠ¡åç§° *</label>
                            <input type="text" id="taskName" v-model="currentTask.name" required
                                   placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">ä»»åŠ¡æè¿°</label>
                            <textarea id="taskDescription" v-model="currentTask.description"
                                      placeholder="è¾“å…¥ä»»åŠ¡è¯¦ç»†æè¿°"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskStatus">çŠ¶æ€ *</label>
                                <select id="taskStatus" v-model="currentTask.status" required>
                                    <option value="pending">å¾…å¤„ç†</option>
                                    <option value="in-progress">è¿›è¡Œä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskPriority">ä¼˜å…ˆçº§ *</label>
                                <select id="taskPriority" v-model="currentTask.priority" required>
                                    <option value="low">ä½</option>
                                    <option value="medium">ä¸­</option>
                                    <option value="high">é«˜</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dueDate">æˆªæ­¢æ—¥æœŸ</label>
                            <input type="date" id="dueDate" v-model="currentTask.dueDate">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">ä¿å­˜</button>
                            <button type="button" class="btn btn-secondary" @click="closeTaskModal">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const isLoggedIn = ref(false);
            const userInfo = ref({});
            const tasks = ref([
                { id: 1, name: 'ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½', description: 'å®ç°ç”¨æˆ·æ³¨å†Œæµç¨‹', status: 'completed', priority: 'high', dueDate: '2023-12-15' },
                { id: 2, name: 'ç™»å½•éªŒè¯', description: 'æ·»åŠ å¤šå› ç´ è®¤è¯', status: 'in-progress', priority: 'medium', dueDate: '2023-12-20' },
                { id: 3, name: 'æ•°æ®åº“ä¼˜åŒ–', description: 'ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½', status: 'pending', priority: 'low', dueDate: '2023-12-25' },
                { id: 4, name: 'APIæ–‡æ¡£ç¼–å†™', description: 'å®Œå–„APIæ–‡æ¡£', status: 'pending', priority: 'medium', dueDate: '2023-12-18' }
            ]);

            const showModal = ref(false);
            const modalTitle = ref('');
            const currentTask = ref({ id: null, name: '', description: '', status: 'pending', priority: 'medium', dueDate: '' });
            const searchTerm = ref('');
            const filterStatus = ref('all');

            // è®¡ç®—å±æ€§
            const filteredTasks = computed(() => {
                return tasks.value.filter(task => {
                    const matchesSearch = !searchTerm.value ||
                        task.name.toLowerCase().includes(searchTerm.value.toLowerCase()) ||
                        (task.description && task.description.toLowerCase().includes(searchTerm.value.toLowerCase()));
                    const matchesFilter = filterStatus.value === 'all' || task.status === filterStatus.value;
                    return matchesSearch && matchesFilter;
                });
            });

            const stats = computed(() => {
                return {
                    totalTasks: tasks.value.length,
                    pendingTasks: tasks.value.filter(t => t.status === 'pending').length,
                    completedTasks: tasks.value.filter(t => t.status === 'completed').length
                };
            });

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const checkAuth = async () => {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    isLoggedIn.value = false;
                    return;
                }

                try {
                    const response = await fetch('/api/v0/login/test-token', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        userInfo.value = userData;
                        isLoggedIn.value = true;
                    } else {
                        // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem('access_token');
                        isLoggedIn.value = false;
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                    isLoggedIn.value = false;
                }
            };

            // ç™»å‡º
            const logout = () => {
                localStorage.removeItem('access_token');
                isLoggedIn.value = false;
                window.location.href = '/login';
            };

            // ä»»åŠ¡ç®¡ç†æ–¹æ³•
            const openAddTaskModal = () => {
                modalTitle.value = 'æ·»åŠ æ–°ä»»åŠ¡';
                currentTask.value = { id: null, name: '', description: '', status: 'pending', priority: 'medium', dueDate: '' };
                showModal.value = true;
            };

            const openEditTaskModal = (task) => {
                modalTitle.value = 'ç¼–è¾‘ä»»åŠ¡';
                currentTask.value = { ...task };
                showModal.value = true;
            };

            const closeTaskModal = () => {
                showModal.value = false;
            };

            const saveTask = () => {
                if (currentTask.value.id) {
                    // ç¼–è¾‘ä»»åŠ¡
                    const index = tasks.value.findIndex(t => t.id === currentTask.value.id);
                    if (index !== -1) {
                        tasks.value[index] = { ...currentTask.value };
                    }
                } else {
                    // æ·»åŠ æ–°ä»»åŠ¡
                    const newId = tasks.value.length > 0 ? Math.max(...tasks.value.map(t => t.id)) + 1 : 1;
                    tasks.value.push({
                        ...currentTask.value,
                        id: newId
                    });
                }
                closeTaskModal();
            };

            const deleteTask = (id) => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                    tasks.value = tasks.value.filter(task => task.id !== id);
                }
            };

            const getStatusText = (status) => {
                switch(status) {
                    case 'pending': return 'å¾…å¤„ç†';
                    case 'in-progress': return 'è¿›è¡Œä¸­';
                    case 'completed': return 'å·²å®Œæˆ';
                    default: return status;
                }
            };

            const getPriorityText = (priority) => {
                switch(priority) {
                    case 'low': return 'ä½';
                    case 'medium': return 'ä¸­';
                    case 'high': return 'é«˜';
                    default: return priority;
                }
            };

            onMounted(() => {
                checkAuth();
            });

            return {
                isLoggedIn,
                userInfo,
                tasks,
                filteredTasks,
                stats,
                showModal,
                modalTitle,
                currentTask,
                searchTerm,
                filterStatus,
                logout,
                openAddTaskModal,
                openEditTaskModal,
                closeTaskModal,
                saveTask,
                deleteTask,
                getStatusText,
                getPriorityText
            };
        }
    }).mount('#app');
</script>
</body>
</html>